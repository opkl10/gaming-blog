---
import AdminLayout from '@/layouts/AdminLayout.astro';
---
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css" />
<AdminLayout title="פוסט חדש">
  <div class="admin-page-content post-editor-page">
    <h1>פוסט חדש</h1>
    <div id="form-error" class="alert alert-error" style="display:none"></div>
    <form id="post-form" class="editor-form">
      <div class="form-group">
        <label for="title">כותרת *</label>
        <input type="text" id="title" name="title" required placeholder="כותרת הפוסט" />
      </div>
      <div class="form-group">
        <label for="slug">קישור (slug)</label>
        <input type="text" id="slug" name="slug" placeholder="ינוצר אוטומטית מהכותרת" />
      </div>
      <div class="form-group">
        <label for="excerpt">כותרת משנה / תקציר</label>
        <textarea id="excerpt" name="excerpt" rows="2" placeholder="משפט או שניים שמתארים את הפוסט"></textarea>
      </div>
      <div class="form-group">
        <label>תוכן הפוסט</label>
        <div id="editor-container" class="rich-editor-wrap"></div>
        <input type="hidden" name="content" id="content" />
      </div>
      <div class="form-group">
        <label for="featured_image">כתובת תמונת כותרת</label>
        <input type="url" id="featured_image" name="featured_image" placeholder="https://..." />
      </div>
      <div class="form-group">
        <label for="meta_description">תיאור SEO</label>
        <input type="text" id="meta_description" name="meta_description" placeholder="תיאור קצר לחיפוש" />
      </div>
      <div class="form-group">
        <label><input type="checkbox" name="is_published" value="1" /> מפורסם</label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">שמור פוסט</button>
        <a href="/admin/posts" class="btn btn-secondary">ביטול</a>
      </div>
    </form>
  </div>
  <script is:inline src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    import { requireAdmin } from '@/scripts/admin-auth.js';
    function init() {
      requireAdmin(async ({ user, supabase }) => {
        const formEl = document.getElementById('post-form');
        if (!formEl) return;
        const editorEl = document.getElementById('editor-container');
        const contentInput = document.getElementById('content');
        let quill = null;
        if (editorEl && typeof Quill !== 'undefined') {
          quill = new Quill(editorEl, {
            theme: 'snow',
            placeholder: 'כתוב כאן את תוכן הפוסט...',
            modules: {
              toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link', 'image', 'blockquote', 'code-block'],
                [{ color: [] }, { background: [] }],
                ['clean']
              ]
            }
          });
        }
        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (contentInput && quill) contentInput.value = quill.root.innerHTML;
          const errEl = document.getElementById('form-error');
          if (errEl) errEl.style.display = 'none';
          let title = document.getElementById('title').value.trim();
          let slug = document.getElementById('slug').value.trim() || title.replace(/\s+/g, '-').replace(/[^\p{L}\p{N}-]/gu, '').toLowerCase();
          const excerpt = document.getElementById('excerpt').value.trim();
          const content = (contentInput && contentInput.value) || (quill ? quill.root.innerHTML : '');
          const featured_image = document.getElementById('featured_image').value.trim() || null;
          const meta_description = document.getElementById('meta_description').value.trim();
          const is_published = document.querySelector('[name="is_published"]').checked;
          const published_at = is_published ? new Date().toISOString() : null;
          const { error } = await supabase.from('posts').insert({
            title, slug, excerpt, content, featured_image, meta_description, is_published, author_id: user.id, published_at
          });
          if (error) { if (errEl) { errEl.textContent = error.message; errEl.style.display = 'block'; } return; }
          window.location.href = '/admin/posts';
        });
      });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</AdminLayout>
