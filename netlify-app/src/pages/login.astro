---
import BaseLayout from '@/layouts/BaseLayout.astro';
---
<BaseLayout title="התחברות" description="התחברות לבלוג">
  <section class="auth-form">
    <div class="container narrow">
      <h1>התחברות</h1>
      <div id="auth-error" class="alert alert-error" style="display:none"></div>
      <form id="login-form">
        <div class="form-group">
          <label for="email">אימייל</label>
          <input type="email" id="email" name="email" required />
        </div>
        <div class="form-group">
          <label for="password">סיסמה</label>
          <input type="password" id="password" name="password" required />
        </div>
        <button type="submit" class="btn btn-primary" id="login-btn">התחבר</button>
      </form>
      <p class="auth-link"><a href="/register">אין לך חשבון? הירשם</a></p>
    </div>
  </section>
  <script>
    import { createClient } from '@supabase/supabase-js';
    const url = import.meta.env.PUBLIC_SUPABASE_URL;
    const key = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
    const errEl = document.getElementById('auth-error');
    const loginForm = document.getElementById('login-form');
    if (!url || !key) {
      if (errEl) { errEl.textContent = 'חסרים הגדרות Supabase. בדוק משתני סביבה ב-Netlify.'; errEl.style.display = 'block'; }
    } else if (loginForm) {
      const supabase = createClient(url, key, {
        auth: { persistSession: true, storageKey: 'sb-gaming-blog-auth', detectSessionInUrl: true }
      });
      const loginFormEl = document.getElementById('login-form');
      if (loginFormEl) loginFormEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('login-btn');
        btn.disabled = true;
        btn.textContent = 'מתחבר...';
        errEl.style.display = 'none';
        try {
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          if (!email || !password) {
            errEl.textContent = 'נא למלא אימייל וסיסמה';
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'התחבר';
            return;
          }
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) {
            errEl.textContent = error.message || 'שגיאה בהתחברות';
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'התחבר';
            return;
          }
          await supabase.auth.getSession();
          btn.textContent = 'מעביר...';
          window.location.href = '/admin';
        } catch (err) {
          const isAbort = err && (err.name === 'AbortError' || (err.message && err.message.includes('aborted')));
          errEl.textContent = isAbort
            ? 'הבקשה בוטלה. נסה שוב (או נסה בחלון פרטי / דפדפן אחר).'
            : ((err && err.message) ? err.message : 'שגיאה בהתחברות. נסה שוב או בדוק את הקונסול (F12).');
          errEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'התחבר';
        }
      });
    }
  </script>
</BaseLayout>
