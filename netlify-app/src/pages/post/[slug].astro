---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';

const { slug } = Astro.params;
const { data: post } = await supabase
  .from('posts')
  .select('*')
  .eq('slug', slug)
  .eq('is_published', true)
  .single();

if (!post) {
  return Astro.redirect('/posts');
}
const description = post.meta_description || (post.excerpt || '').slice(0, 160);
---
<BaseLayout title={post.title} description={description}>
  <article class="single-post">
    <div class="container">
      {post.featured_image && (
        <div class="post-featured-image">
          <img src={post.featured_image} alt={post.title} />
        </div>
      )}
      <header class="post-header">
        <h1>{post.title}</h1>
        <p class="post-meta">
          {post.published_at ? new Date(post.published_at).toLocaleString('he-IL') : ''}
        </p>
      </header>
      <div class="post-content prose" set:html={post.content || ''} />
    </div>
  </article>
</BaseLayout>
